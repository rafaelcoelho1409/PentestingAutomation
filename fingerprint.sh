#!/bin/bash
optstring=":hf:a:"
export PATH=~/go/bin:~/.cargo/bin:$PATH
TOOLS_PATH=~/TOOLS

#---AUXILIARY FUNCTIONS---
help_function() {
    echo "
    FINGERPRINT

    Args:
        Warning: Use only folder name without spacebar
        [-f] Folder to store all data from vulnerability scan
        [-a] Choose a specific task to be done
            Options:
            - B01_WEBANALYZE
        [-h] Help"
    exit 0
}   

run_task() {
    if [[ -n ${folder_init} ]]; then
        ${1}
    else
        echo "Error while running task ${2}"
        exit 1
    fi
}

banner() {
    printf '%*s' 100 | tr ' ' '-'
    echo -e "\n"
    echo -e "${1}\n"
    printf '%*s' 100 | tr ' ' '-'
    echo -e "\n"
}

clean_string() {
    local input=${1}
    # Replace - and / with _
    input="${input//[-\/]/_}"
    # Remove leading _ or /
    input="${input#[_/]}"
    # Remove trailing _ or /
    input="${input%[_/]}"
    echo "${input}"
}


#---MAIN FUNCTIONS---
B01_WEBANALYZE() {
    stage="B01_WEBANALYZE"
    banner "FINGERPRINT - ${stage}"
    if [[ -e "${rec_folder}/subdomains/subdomains_probe.txt" ]]; then
        if [[ ! -d "${folder}/BBB_fingerprint" ]]; then
            mkdir -p "${folder}/BBB_fingerprint"
        fi
        webanalyze \
            -hosts "${rec_folder}/subdomains/subdomains_probe.txt" \
            -worker 1000 \
            | tee -a "${folder}/BBB_fingerprint/_webanalyze.txt"
        cat "${folder}/BBB_fingerprint/_webanalyze.txt" \
            | grep -n '<no results>' \
            | cut -d: -f1 \
            | awk '{ print $0 "\n" $0-1 }' \
            > "${folder}/BBB_fingerprint/_webanalyze_lines_to_remove.txt"
        awk 'NR==FNR{lines[$1]; next} !(FNR in lines)' \
            "${folder}/BBB_fingerprint/_webanalyze_lines_to_remove.txt" \
            "${folder}/BBB_fingerprint/_webanalyze.txt" \
            | awk "NF" \
            > "${folder}/BBB_fingerprint/webanalyze.txt"
        rm "${folder}/BBB_fingerprint/_webanalyze_lines_to_remove.txt"
        rm "${folder}/BBB_fingerprint/_webanalyze.txt"
    fi
}



#------------------------
while getopts ${optstring} options; do
    case ${options} in
        f)
            folder_init="${OPTARG}"
            folder=${folder_init}/Vulnerabilities
            rec_folder=${folder_init}/Reconnaissance
            nuclei_input="${rec_folder}/subdomains/subdomains_probe.txt"
            if [[ ! -d "${folder}" ]]; then
                mkdir "${folder}"
            fi
            ;;  
        a)
            task="${OPTARG}"
            case ${task} in 
                "B01_WEBANALYZE")
                    run_task B01_WEBANALYZE "B01_WEBANALYZE"
                    ;;
                esac
            ;;
        h)
            help_function
            exit 0
            ;;
        ?)
            echo "Error"
            exit 1
            ;;
        esac
    done