#!/bin/bash

SHORTSCAN() {
    stage="SHORTSCAN"
    #MICROSOFT - WINDOWS SERVER - IIS
    if [[ -e "${rec_folder}/httpx.txt" ]]; then
        if [[ ! -d "${folder}/shortscan" ]]; then
            mkdir "${folder}/shortscan"
        fi
        for subdomain in $(\
            cat "${rec_folder}/httpx.txt" | \
            grep "Windows Server" | \
            sed -r 's/\x1B\[[0-9;]*[mK]//g' | \
            grep "\[200\]"  | \
            grep -oE 'https?://[^ ]+'); do
            subdomain_txt=$(echo "${subdomain}" | \
                sed -e 's|^http://||' -e 's|^https://||')
            shortscan ${subdomain} | tee "${folder}/shortscan/${subdomain_txt}.txt"
        done
    fi
}

LINKFINDER() {
    stage="LINKFINDER"
    source ${TOOLS_PATH}/virtual_environments/linkfinder_env/bin/activate
    cd ${TOOLS_PATH}/LinkFinder
    if [[ ! -d "${folder}/linkfinder" ]]; then
        mkdir "${folder}/linkfinder"
    fi
    #stage 1: RECONNAISSANCE/katana.txt
    echo "STAGE 1"
    if [[ -e "${rec_folder}/katana.txt" ]]; then
        for subdomain in $(\
            cat "${rec_folder}/katana.txt" | \
            grep "\.js"); do
        #    subdomain_txt=$(echo "${subdomain}" | \
        #        sed -e 's|^http://||' -e 's|^https://||')
            echo -e "${subdomain}\n\n" >> "${folder}/linkfinder/katana.txt"
            python3 linkfinder.py -i ${subdomain} \
                -o cli  >> "${folder}/linkfinder/katana.txt"
            printf '%*s' 70 | tr ' ' '-' >> "${folder}/linkfinder/katana.txt"
            echo -e "\n" >> "${folder}/linkfinder/katana.txt"
        done
    fi
    deactivate
}