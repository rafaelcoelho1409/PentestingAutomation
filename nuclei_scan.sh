#!/bin/bash
optstring=":hf:a:b:"
export PATH=~/go/bin:~/.cargo/bin:$PATH
TOOLS_PATH=~/TOOLS
#(1) Create NUCLEI_API to check APIs

#---AUXILIARY FUNCTIONS---
help_function() {
    echo "
    NUCLEI SCAN (NS)

    Args:
        Warning: Use only folder name without spacebar
        [-f] Folder to store all data from vulnerability scan
        [-a] Choose a specific task to be done
        [-b] Change the file with domain names as input for Nuclei scans
             (Use this flag before -a flag)
            Options:
            - N01_NUCLEI_API
            - N01_NUCLEI_GRAPHQL
            - N02_NUCLEI_OPEN_REDIRECT
            - N03_NUCLEI_IDOR
            - N04_NUCLEI_XXE
            - N05_NUCLEI_RCE
            - N06_NUCLEI_FILE_INCLUSION
            - N07_NUCLEI_COOKIE
            - N08_NUCLEI_OAUTH
            - N09_NUCLEI_TAKEOVER
            - N10_NUCLEI_TRAVERSAL
            - N11_NUCLEI_CRLF_INJECTION
            - N12_NUCLEI_XSS
            - N13_NUCLEI_TEMPLATE_INJECTION
            - N14_NUCLEI_SSRF
            - N15_NUCLEI_SQL_INJECTION
            - N16_NUCLEI_HTTP_CNVD
            - N17_NUCLEI_HTTP_CVES
            - N18_NUCLEI_HTTP_DEFAULT_LOGINS
            - N19_NUCLEI_HTTP_EXPOSED_PANELS
            - N20_NUCLEI_HTTP_EXPOSURES
            - N21_NUCLEI_HTTP_MISCONFIGURATION
            - N22_NUCLEI_HTTP_TECHNOLOGIES
            - N23_NUCLEI_HTTP_VULNERABILITIES
            - N24_NUCLEI_JAVASCRIPT
            - N25_NUCLEI_SSL
            - N26_NUCLEI_DAST
            - N27_NUCLEI_HEADLESS
            - N28_NUCLEI_DNS
        [-h] Help"
    exit 0
}   

run_task() {
    if [[ -n ${folder_init} ]]; then
        ${1}
    else
        echo "Error while running task ${2}"
        exit 1
    fi
}

banner() {
    printf '%*s' 100 | tr ' ' '-'
    echo -e "\n"
    echo -e "${1}\n"
    printf '%*s' 100 | tr ' ' '-'
    echo -e "\n"
}

clean_string() {
    local input=${1}
    # Replace - and / with _
    input="${input//[-\/]/_}"
    # Remove leading _ or /
    input="${input#[_/]}"
    # Remove trailing _ or /
    input="${input%[_/]}"
    echo "${input}"
}

nuclei_template() {
    name=${1}
    code=${2}
    name_on_file=$(clean_string ${name})
    if [[ ! -d "${folder}/NUC_nuclei/templates" ]]; then
        mkdir -p "${folder}/NUC_nuclei/templates"
        #getting all nuclei templates
        nuclei -tl > "${folder}/NUC_nuclei/templates/nuclei_all_templates.txt"
    fi
    cat "${folder}/NUC_nuclei/templates/nuclei_all_templates.txt" \
        | grep -- "${name}" \
        > "${folder}/NUC_nuclei/templates/${code}_${name_on_file}_templates.txt"
}

nuclei_template2() {
    name=${1}
    code=${2}
    name_on_file=${3}
    if [[ ! -d "${folder}/NUC_nuclei/templates" ]]; then
        mkdir -p "${folder}/NUC_nuclei/templates"
        #getting all nuclei templates
        nuclei -tl > "${folder}/NUC_nuclei/templates/nuclei_all_templates.txt"
    fi
    cat "${folder}/NUC_nuclei/templates/nuclei_all_templates.txt" \
        | grep -- "${name}" \
        > "${folder}/NUC_nuclei/templates/${code}_${name_on_file}_templates.txt"
}

nuclei_scan() {
    name=${1}
    code=${2}
    path_name=${3}
    additional_args=${4}
    name_on_file=$(clean_string ${name})
    #----------------------------------------------
    if [[ ! -d "${folder}/${path_name}" ]]; then
        mkdir -p "${folder}/${path_name}"
    fi
    if [[ -e ${nuclei_input} ]]; then
        eval nuclei \
            -t "${folder}/NUC_nuclei/templates/${code}_${name_on_file}_templates.txt" \
            -es "info" \
            -l ${nuclei_input} \
            -o "${folder}/${path_name}/${name_on_file}_nuclei.txt" \
            -silent \
            -rl 1000 \
            -timeout 5 \
            ${additional_args}
    fi
}

nuclei_scan2() {
    name=${1}
    code=${2}
    path_name=${3}
    additional_args=${4}
    name_on_file=$(clean_string ${name})
    #----------------------------------------------
    if [[ ! -d "${folder}/${path_name}" ]]; then
        mkdir -p "${folder}/${path_name}"
    fi
    if [[ -e ${nuclei_input} ]]; then
        eval nuclei \
            -t ${name} \
            -es "info" \
            -l ${nuclei_input} \
            -o "${folder}/${path_name}/${name_on_file}_nuclei.txt" \
            -silent \
            -timeout 5 \
            ${additional_args}
    fi
}

#---MAIN FUNCTIONS---
N01_NUCLEI_API() {
    stage="N01_NUCLEI_API"
    banner "NUCLEI SCAN - ${stage}"
    name="api"
    code="N01"
    path_name="V05_api"
    nuclei_template ${name} ${code}
    nuclei_scan ${name} ${code} ${path_name}
}

N01_NUCLEI_GRAPHQL() {
    stage="N01_NUCLEI_GRAPHQL"
    banner "NUCLEI SCAN - ${stage}"
    name="graphql"
    code="N01"
    path_name="V05_api/graphql"
    nuclei_template ${name} ${code}
    nuclei_scan ${name} ${code} ${path_name}
}

N02_NUCLEI_OPEN_REDIRECT() {
    stage="N02_NUCLEI_OPEN_REDIRECT"
    banner "NUCLEI SCAN - ${stage}"
    name="open-redirect"
    code="N02"
    path_name="V06_open_redirect"
    nuclei_template ${name} ${code}
    nuclei_scan ${name} ${code} ${path_name}
}

N03_NUCLEI_IDOR() {
    stage="N03_NUCLEI_IDOR"
    banner "NUCLEI SCAN - ${stage}"
    name="idor"
    code="N03"
    path_name="V07_idor"
    nuclei_template ${name} ${code}
    nuclei_scan ${name} ${code} ${path_name}
}

N04_NUCLEI_XXE() {
    stage="N04_NUCLEI_XXE"
    banner "NUCLEI SCAN - ${stage}"
    name="xxe"
    code="N04"
    path_name="V08_xxe"
    nuclei_template ${name} ${code}
    nuclei_scan ${name} ${code} ${path_name}
}

N05_NUCLEI_RCE() {
    stage="N05_NUCLEI_RCE"
    banner "NUCLEI SCAN - ${stage}"
    name="-rce"
    code="N05"
    path_name="V09_rce"
    nuclei_template ${name} ${code}
    nuclei_scan ${name} ${code} ${path_name}
}

N06_NUCLEI_FILE_INCLUSION() {
    stage="N06_NUCLEI_FILE_INCLUSION"
    banner "NUCLEI SCAN - ${stage}"
    name="file-inclusion"
    code="N06"
    path_name="V10_file_inclusion"
    nuclei_template ${name} ${code}
    nuclei_scan ${name} ${code} ${path_name}
}

N07_NUCLEI_COOKIE() {
    stage="N07_NUCLEI_COOKIE"
    banner "NUCLEI SCAN - ${stage}"
    name="cookie"
    code="N07"
    path_name="V11_cookie"
    nuclei_template ${name} ${code}
    nuclei_scan ${name} ${code} ${path_name}
}

N08_NUCLEI_OAUTH() {
    stage="N08_NUCLEI_OAUTH"
    banner "NUCLEI SCAN - ${stage}"
    name="oauth"
    code="N08"
    path_name="V12_oauth"
    nuclei_template ${name} ${code}
    nuclei_scan ${name} ${code} ${path_name}
}

N09_NUCLEI_TAKEOVER() {
    stage="N09_NUCLEI_TAKEOVER"
    banner "NUCLEI SCAN - ${stage}"
    name="takeover"
    code="N09"
    path_name="V13_takeover"
    nuclei_template ${name} ${code}
    nuclei_scan ${name} ${code} ${path_name}
}

N10_NUCLEI_TRAVERSAL() {
    stage="N10_NUCLEI_TRAVERSAL"
    banner "NUCLEI SCAN - ${stage}"
    name="traversal"
    code="N10"
    path_name="V14_traversal"
    nuclei_template ${name} ${code}
    nuclei_scan ${name} ${code} ${path_name}
}

N11_NUCLEI_CRLF_INJECTION() {
    stage="N11_NUCLEI_CRLF_INJECTION"
    banner "NUCLEI SCAN - ${stage}"
    name="crlf-injection"
    code="N11"
    path_name="V15_crlf_injection"
    nuclei_template ${name} ${code}
    nuclei_scan ${name} ${code} ${path_name}
}

N12_NUCLEI_XSS() {
    stage="N12_NUCLEI_XSS"
    banner "NUCLEI SCAN - ${stage}"
    name="xss"
    code="N12"
    path_name="V18_xss"
    nuclei_input="${rec_folder}/final_data/final_data_httpx_urls_noext.txt"
    nuclei_template ${name} ${code}
    nuclei_scan ${name} ${code} ${path_name}
}

N13_NUCLEI_TEMPLATE_INJECTION() {
    stage="N13_NUCLEI_TEMPLATE_INJECTION"
    banner "NUCLEI SCAN - ${stage}"
    name="template-injection"
    code="N13"
    path_name="V19_template_injection"
    additional_args="-dast -headless"
    nuclei_template ${name} ${code}
    nuclei_scan ${name} ${code} ${path_name} ${additional_args}
}

N14_NUCLEI_SSRF() {
    stage="N14_NUCLEI_SSRF"
    banner "NUCLEI SCAN - ${stage}"
    name="ssrf"
    code="N14"
    path_name="V20_ssrf"
    nuclei_template ${name} ${code}
    nuclei_scan ${name} ${code} ${path_name}
}

N15_NUCLEI_SQL_INJECTION() {
    stage="N15_NUCLEI_SQL_INJECTION"
    banner "NUCLEI SCAN - ${stage}"
    name="sql-injection"
    code="N15"
    path_name="V22_sql_injection"
    nuclei_input="${rec_folder}/final_data/final_data_httpx_urls_noext.txt"
    nuclei_template ${name} ${code}
    nuclei_scan ${name} ${code} ${path_name}
}

N16_NUCLEI_HTTP_CNVD() {
    stage="N16_NUCLEI_HTTP_CNVD"
    banner "NUCLEI SCAN - ${stage}"
    name="http/cnvd/"
    code="N16"
    path_name="N01_nuclei_scans"
    nuclei_input="${rec_folder}/final_data/final_data_httpx_urls_noext.txt"
    nuclei_template2 ${name} ${code} ${name_on_file}
    nuclei_scan2 ${name} ${code} ${path_name}
}

N17_NUCLEI_HTTP_CVES() {
    stage="N17_NUCLEI_HTTP_CVES"
    banner "NUCLEI SCAN - ${stage}"
    name="http/cves/"
    code="N17"
    path_name="N01_nuclei_scans"
    additional_args="-headless"
    nuclei_input="${rec_folder}/final_data/final_data_httpx_urls_noext.txt"
    nuclei_template2 ${name} ${code} ${name_on_file}
    nuclei_scan2 ${name} ${code} ${path_name} ${additional_args}
}

N18_NUCLEI_HTTP_DEFAULT_LOGINS() {
    stage="N18_NUCLEI_HTTP_DEFAULT_LOGINS"
    banner "NUCLEI SCAN - ${stage}"
    name="http/default-logins/"
    code="N18"
    path_name="N01_nuclei_scans"
    nuclei_input="${rec_folder}/final_data/final_data_httpx_urls_noext.txt"
    nuclei_template2 ${name} ${code} ${name_on_file}
    nuclei_scan2 ${name} ${code} ${path_name}
}

N19_NUCLEI_HTTP_EXPOSED_PANELS() {
    stage="N19_NUCLEI_HTTP_EXPOSED_PANELS"
    banner "NUCLEI SCAN - ${stage}"
    name="http/exposed-panels/"
    code="N19"
    path_name="N01_nuclei_scans"
    nuclei_input="${rec_folder}/final_data/final_data_httpx_urls_noext.txt"
    nuclei_template2 ${name} ${code} ${name_on_file}
    nuclei_scan2 ${name} ${code} ${path_name}
}

N20_NUCLEI_HTTP_EXPOSURES() {
    stage="N20_NUCLEI_HTTP_EXPOSURES"
    banner "NUCLEI SCAN - ${stage}"
    name="http/exposures/"
    code="N20"
    path_name="N01_nuclei_scans"
    nuclei_input="${rec_folder}/final_data/final_data_httpx_urls_noext.txt"
    nuclei_template2 ${name} ${code} ${name_on_file}
    nuclei_scan2 ${name} ${code} ${path_name}
}

N21_NUCLEI_HTTP_MISCONFIGURATION() {
    stage="N21_NUCLEI_HTTP_MISCONFIGURATION"
    banner "NUCLEI SCAN - ${stage}"
    name="http/misconfiguration/"
    code="N21"
    path_name="N01_nuclei_scans"
    nuclei_input="${rec_folder}/final_data/final_data_httpx_urls_noext.txt"
    nuclei_template2 ${name} ${code} ${name_on_file}
    nuclei_scan2 ${name} ${code} ${path_name}
}

N22_NUCLEI_HTTP_TECHNOLOGIES() {
    stage="N22_NUCLEI_HTTP_TECHNOLOGIES"
    banner "NUCLEI SCAN - ${stage}"
    name="http/technologies/"
    code="N22"
    path_name="N01_nuclei_scans"
    nuclei_input="${rec_folder}/final_data/final_data_httpx_urls_noext.txt"
    nuclei_template2 ${name} ${code} ${name_on_file}
    nuclei_scan2 ${name} ${code} ${path_name}
}

N23_NUCLEI_HTTP_VULNERABILITIES() {
    stage="N23_NUCLEI_HTTP_VULNERABILITIES"
    banner "NUCLEI SCAN - ${stage}"
    name="http/vulnerabilities/"
    code="N23"
    path_name="N01_nuclei_scans"
    nuclei_input="${rec_folder}/final_data/final_data_httpx_urls_noext.txt"
    nuclei_template2 ${name} ${code} ${name_on_file}
    nuclei_scan2 ${name} ${code} ${path_name}
}

N24_NUCLEI_JAVASCRIPT() {
    stage="N24_NUCLEI_JAVASCRIPT"
    banner "NUCLEI SCAN - ${stage}"
    name="javascript/"
    code="N24"
    path_name="N01_nuclei_scans"
    nuclei_input="${rec_folder}/final_data/final_data_httpx_urls_noext.txt"
    nuclei_template2 ${name} ${code} ${name_on_file}
    nuclei_scan2 ${name} ${code} ${path_name}
}

N25_NUCLEI_SSL() {
    stage="N25_NUCLEI_SSL"
    banner "NUCLEI SCAN - ${stage}"
    name="ssl/"
    code="N25"
    path_name="N01_nuclei_scans"
    nuclei_input="${rec_folder}/final_data/final_data_httpx_urls_noext.txt"
    nuclei_template2 ${name} ${code} ${name_on_file}
    nuclei_scan2 ${name} ${code} ${path_name}
}

N26_NUCLEI_DAST() {
    stage="N26_NUCLEI_DAST"
    banner "NUCLEI SCAN - ${stage}"
    name="dast/"
    code="N26"
    additional_args="-dast -headless"
    path_name="N01_nuclei_scans"
    nuclei_input="${rec_folder}/final_data/final_data_httpx_urls_noext.txt"
    nuclei_template2 ${name} ${code} ${name_on_file}
    nuclei_scan2 ${name} ${code} ${path_name} ${additional_args}
}

N27_NUCLEI_HEADLESS() {
    stage="N27_NUCLEI_HEADLESS"
    banner "NUCLEI SCAN - ${stage}"
    name="headless/"
    code="N27"
    additional_args="-headless"
    path_name="N01_nuclei_scans"
    nuclei_input="${rec_folder}/final_data/final_data_httpx_urls_noext.txt"
    nuclei_template2 ${name} ${code} ${name_on_file}
    nuclei_scan2 ${name} ${code} ${path_name} ${additional_args}
}

N28_NUCLEI_DNS() {
    stage="N28_NUCLEI_DNS"
    banner "NUCLEI SCAN - ${stage}"
    name="dns/"
    code="N28"
    path_name="N01_nuclei_scans"
    nuclei_input="${rec_folder}/final_data/final_data_httpx_urls_noext.txt"
    nuclei_template2 ${name} ${code} ${name_on_file}
    nuclei_scan2 ${name} ${code} ${path_name}
}

#----------------------------------------------
while getopts ${optstring} options; do
    case ${options} in
        f)
            folder_init="${OPTARG}"
            folder=${folder_init}/Vulnerabilities
            rec_folder=${folder_init}/Reconnaissance
            nuclei_input="${rec_folder}/subdomains/subdomains_probe.txt"
            if [[ ! -d "${folder}" ]]; then
                mkdir "${folder}"
            fi
            ;;  
        b)
            nuclei_input="${OPTARG}"
            ;;
        a)
            task="${OPTARG}"
            case ${task} in 
                "N01_NUCLEI_API")
                    run_task N01_NUCLEI_API "N01_NUCLEI_API"
                    ;;
                "N01_NUCLEI_GRAPHQL")
                    run_task N01_NUCLEI_GRAPHQL "N01_NUCLEI_GRAPHQL"
                    ;;
                "N02_NUCLEI_OPEN_REDIRECT")
                    run_task N02_NUCLEI_OPEN_REDIRECT "N02_NUCLEI_OPEN_REDIRECT"
                    ;;
                "N03_NUCLEI_IDOR")
                    run_task N03_NUCLEI_IDOR "N03_NUCLEI_IDOR"
                    ;;
                "N04_NUCLEI_XXE")
                    run_task N04_NUCLEI_XXE "N04_NUCLEI_XXE"
                    ;;
                "N05_NUCLEI_RCE")
                    run_task N05_NUCLEI_RCE "N05_NUCLEI_RCE"
                    ;;
                "N06_NUCLEI_FILE_INCLUSION")
                    run_task N06_NUCLEI_FILE_INCLUSION "N06_NUCLEI_FILE_INCLUSION"
                    ;;
                "N07_NUCLEI_COOKIE")
                    run_task N07_NUCLEI_COOKIE "N07_NUCLEI_COOKIE"
                    ;;
                "N08_NUCLEI_OAUTH")
                    run_task N08_NUCLEI_OAUTH "N08_NUCLEI_OAUTH"
                    ;;
                "N09_NUCLEI_TAKEOVER")
                    run_task N09_NUCLEI_TAKEOVER "N09_NUCLEI_TAKEOVER"
                    ;;
                "N10_NUCLEI_TRAVERSAL")
                    run_task N10_NUCLEI_TRAVERSAL "N10_NUCLEI_TRAVERSAL"
                    ;;
                "N11_NUCLEI_CRLF_INJECTION")
                    run_task N11_NUCLEI_CRLF_INJECTION "N11_NUCLEI_CRLF_INJECTION"
                    ;;
                "N12_NUCLEI_XSS")
                    run_task N12_NUCLEI_XSS "N12_NUCLEI_XSS"
                    ;;
                "N13_NUCLEI_TEMPLATE_INJECTION")
                    run_task N13_NUCLEI_TEMPLATE_INJECTION "N13_NUCLEI_TEMPLATE_INJECTION"
                    ;;
                "N14_NUCLEI_SSRF")
                    run_task N14_NUCLEI_SSRF "N14_NUCLEI_SSRF"
                    ;;
                "N15_NUCLEI_SQL_INJECTION")
                    run_task N15_NUCLEI_SQL_INJECTION "N15_NUCLEI_SQL_INJECTION"
                    ;;
                "N16_NUCLEI_HTTP_CNVD")
                    run_task N16_NUCLEI_HTTP_CNVD "N16_NUCLEI_HTTP_CNVD"
                    ;;
                "N17_NUCLEI_HTTP_CVES")
                    run_task N17_NUCLEI_HTTP_CVES "N17_NUCLEI_HTTP_CVES"
                    ;;
                "N18_NUCLEI_HTTP_DEFAULT_LOGINS")
                    run_task N18_NUCLEI_HTTP_DEFAULT_LOGINS "N18_NUCLEI_HTTP_DEFAULT_LOGINS"
                    ;;
                "N19_NUCLEI_HTTP_EXPOSED_PANELS")
                    run_task N19_NUCLEI_HTTP_EXPOSED_PANELS "N19_NUCLEI_HTTP_EXPOSED_PANELS"
                    ;;
                "N20_NUCLEI_HTTP_EXPOSURES")
                    run_task N20_NUCLEI_HTTP_EXPOSURES "N20_NUCLEI_HTTP_EXPOSURES"
                    ;;
                "N21_NUCLEI_HTTP_MISCONFIGURATION")
                    run_task N21_NUCLEI_HTTP_MISCONFIGURATION "N21_NUCLEI_HTTP_MISCONFIGURATION"
                    ;;
                "N22_NUCLEI_HTTP_TECHNOLOGIES")
                    run_task N22_NUCLEI_HTTP_TECHNOLOGIES "N22_NUCLEI_HTTP_TECHNOLOGIES"
                    ;;
                "N23_NUCLEI_HTTP_VULNERABILITIES")
                    run_task N23_NUCLEI_HTTP_VULNERABILITIES "N23_NUCLEI_HTTP_VULNERABILITIES"
                    ;;
                "N24_NUCLEI_JAVASCRIPT")
                    run_task N24_NUCLEI_JAVASCRIPT "N24_NUCLEI_JAVASCRIPT"
                    ;;
                "N25_NUCLEI_SSL")
                    run_task N25_NUCLEI_SSL "N25_NUCLEI_SSL"
                    ;;
                "N26_NUCLEI_DAST")
                    run_task N26_NUCLEI_DAST "N26_NUCLEI_DAST"
                    ;;
                "N27_NUCLEI_HEADLESS")
                    run_task N27_NUCLEI_HEADLESS "N27_NUCLEI_HEADLESS"
                    ;;
                "N28_NUCLEI_DNS")
                    run_task N28_NUCLEI_DNS "N28_NUCLEI_DNS"
                    ;;
                esac
            ;;
        h)
            help_function
            exit 0
            ;;
        ?)
            echo "Error"
            exit 1
            ;;
        esac
    done
#------------------------------
