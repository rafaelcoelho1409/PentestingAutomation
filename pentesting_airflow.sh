#!/bin/bash
optstring=":hd:f:"
TOOLS_PATH=~/TOOLS

#---AUXILIARY FUNCTIONS---
help_function() {
    echo "
    PENTESTING - AIRFLOW

    Args:
        Warning: Use only folder name without spacebar
        [-d] File with domains to be scanned
        [-f] Folder to store all data from automation
        [-h] Help"
    exit 0
}   

while getopts ${optstring} options; do
    case ${options} in
        d)
            domains_file="${OPTARG}"
            ;;
        f)
            folder_init="${OPTARG}"
            ;;
        #r)
        #    no_dag_run=0
        #    ;;
        h)
            help_function
            ;;
        ?)
            echo "Error"
            exit 1
            ;;
        esac
    done

#---EXECUTION---
#GraphQL > Eyewitness to check version
if [[ -n ${domains_file} && -n ${folder_init} ]]; then
    #source echostriker_env/bin/activate
    python3 -m airflow scheduler &
    python3 -m airflow db init &
    cp pentesting_airflow.py "${AIRFLOW_HOME}/dags"
    python3 -m airflow webserver --port 8080 &
    python3 -m airflow variables set domains ${domains_file}
    python3 -m airflow variables set folder ${folder_init}
    #if [[ -n ${no_dag_run} ]]; then
    #    python3 -m airflow dags trigger pentesting_dag
    #fi
    wait
else
    echo "Error"
    exit 1
fi