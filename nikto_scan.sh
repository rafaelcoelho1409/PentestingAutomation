#!/bin/bash
optstring=":hf:a:"
export PATH=~/go/bin:~/.cargo/bin:$PATH
TOOLS_PATH=~/TOOLS

#---AUXILIARY FUNCTIONS---
help_function() {
    echo "
    NIKTO SCAN

    Args:
        Warning: Use only folder name without spacebar
        [-f] Folder to store all data from vulnerability scan
        [-a] Choose a specific task to be done
            Options:
            - A01_NIKTO_INTERESTING_FILES
            - A02_NIKTO_MISCONFIGURATION
            - A03_NIKTO_INFORMATION_DISCLOSURE
            - A04_NIKTO_INJECTION
            - A05_NIKTO_REMOTE_FILE_RETRIEVAL1 (Inside Web Root)
            - A06_NIKTO_DENIAL_OF_SERVICE
            - A07_NIKTO_REMOTE_FILE_RETRIEVAL2 (Server Wide)
            - A08_NIKTO_COMMAND_EXECUTION
            - A09_NIKTO_SQL_INJECTION
            - A10_NIKTO_FILE_UPLOAD
            - A11_NIKTO_AUTHENTICATION_BYPASS
            - A12_NIKTO_SOFTWARE_IDENTIFICATION
            - A13_NIKTO_REMOTE_SOURCE_INCLUSION
            - A14_NIKTO_WEBSERVICE
            - A15_NIKTO_ADMINISTRATIVE_CONSOLE
        [-h] Help"
    exit 0
}   

run_task() {
    if [[ -n ${folder_init} ]]; then
        ${1}
    else
        echo "Error while running task ${2}"
        exit 1
    fi
}

banner() {
    printf '%*s' 100 | tr ' ' '-'
    echo -e "\n"
    echo -e "${1}\n"
    printf '%*s' 100 | tr ' ' '-'
    echo -e "\n"
}

clean_string() {
    local input=${1}
    # Replace - and / with _
    input="${input//[-\/]/_}"
    # Remove leading _ or /
    input="${input#[_/]}"
    # Remove trailing _ or /
    input="${input%[_/]}"
    echo "${input}"
}

nikto_scan() {
    path_name=${1}
    option=${2}
    file_to_scan=${3}
    #----------------------------------------
    if [[ -e ${file_to_scan} ]]; then
        if [[ ! -d "${folder}/${path_name}" ]]; then
            mkdir -p "${folder}/${path_name}"
        fi
        for x in $(\
            cat ${file_to_scan}); do
            x_txt=$(echo "${x}" \
                | sed -e 's|^http://||' -e 's|^https://||')
            sleep 1
            echo ${x}
            nikto \
                -h ${x} \
                -Tuning ${option} \
                -timeout 5 \
                -output "${folder}/${path_name}/${x_txt}.txt" &
        done
        sleep 600
        #while :; do
        #    num_proc=$(ps aux | grep -E "nikto|Tuning ${option}" | wc -l)
        #    total_proc=$(cat ${file_to_scan} | wc -l)
        #    perc=$(python3 -c "a = ("${num_proc}"/"${total_proc}")*100; print(a)")
        #    #num_proc <= 3 means that ps aus found only 
        #    #an acceptable number of requests remaining from num_proc
        #    if [[ ${num_proc} -le 3 ]]; then
        #        echo "Over 90% Nikto processes finished."
        #        break
        #    fi
        #    sleep 60
        #    banner "Nikto processes: ${num_proc}"
        #done
    fi
}


#---MAIN FUNCTIONS---
A01_NIKTO_INTERESTING_FILES() {
    stage="A01_NIKTO_INTERESTING_FILES"
    banner "NIKTO SCAN - ${stage}"
    path_name="AAA_nikto_scans/A01_interesting_files/nikto"
    option=1
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A02_NIKTO_MISCONFIGURATION() {
    stage="A02_NIKTO_MISCONFIGURATION"
    banner "NIKTO SCAN - ${stage}"
    path_name="AAA_nikto_scans/A02_misconfiguration/nikto"
    option=2
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A03_NIKTO_INFORMATION_DISCLOSURE() {
    stage="A03_NIKTO_INFORMATION_DISCLOSURE"
    banner "NIKTO SCAN - ${stage}"
    path_name="V23_information_disclosure/nikto"
    option=3
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A04_NIKTO_INJECTION() {
    stage="A04_NIKTO_INJECTION"
    banner "NIKTO SCAN - ${stage}"
    path_name="AAA_nikto_scans/A04_injection/nikto"
    option=4
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A05_NIKTO_REMOTE_FILE_RETRIEVAL1() {
    stage="A05_NIKTO_REMOTE_FILE_RETRIEVAL1"
    banner "NIKTO SCAN - ${stage}"
    path_name="AAA_nikto_scans/A05_remote_file_retrieval1/nikto"
    option=5
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A06_NIKTO_DENIAL_OF_SERVICE() {
    stage="A06_NIKTO_DENIAL_OF_SERVICE"
    banner "NIKTO SCAN - ${stage}"
    path_name="AAA_nikto_scans/A06_denial_of_service/nikto"
    option=6
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A07_NIKTO_REMOTE_FILE_RETRIEVAL2() {
    stage="A07_NIKTO_REMOTE_FILE_RETRIEVAL2"
    banner "NIKTO SCAN - ${stage}"
    path_name="AAA_nikto_scans/A07_remote_file_retrieval2/nikto"
    option=7
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A08_NIKTO_COMMAND_EXECUTION() {
    stage="A08_NIKTO_COMMAND_EXECUTION"
    banner "NIKTO SCAN - ${stage}"
    path_name="AAA_nikto_scans/A08_command_execution/nikto"
    option=8
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A09_NIKTO_SQL_INJECTION() {
    stage="A09_NIKTO_SQL_INJECTION"
    banner "NIKTO SCAN - ${stage}"
    path_name="V22_sql_injection/nikto"
    option=9
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A10_NIKTO_FILE_UPLOAD() {
    stage="A10_NIKTO_FILE_UPLOAD"
    banner "NIKTO SCAN - ${stage}"
    path_name="V10_file_inclusion/nikto"
    option=0
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A11_NIKTO_AUTHENTICATION_BYPASS() {
    stage="A11_NIKTO_AUTHENTICATION_BYPASS"
    banner "NIKTO SCAN - ${stage}"
    path_name="AAA_nikto_scans/A11_authentication_bypass/nikto"
    option=a
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A12_NIKTO_SOFTWARE_IDENTIFICATION() {
    stage="A12_NIKTO_SOFTWARE_IDENTIFICATION"
    banner "NIKTO SCAN - ${stage}"
    path_name="BBB_fingerprint/A12_nikto_software_identification/nikto"
    option=b
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A13_NIKTO_REMOTE_SOURCE_INCLUSION() {
    stage="A13_NIKTO_REMOTE_SOURCE_INCLUSION"
    banner "NIKTO SCAN - ${stage}"
    path_name="V10_file_inclusion/nikto"
    option=c
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A14_NIKTO_WEBSERVICE() {
    stage="A14_NIKTO_WEBSERVICE"
    banner "NIKTO SCAN - ${stage}"
    path_name="V05_api/nikto"
    option=d
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A15_NIKTO_ADMINISTRATIVE_CONSOLE() {
    stage="A15_NIKTO_ADMINISTRATIVE_CONSOLE"
    banner "NIKTO SCAN - ${stage}"
    path_name="AAA_nikto_scans/A15_administrative_console/nikto"
    option=e
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}


#------------------------
while getopts ${optstring} options; do
    case ${options} in
        f)
            folder_init="${OPTARG}"
            folder=${folder_init}/Vulnerabilities
            rec_folder=${folder_init}/Reconnaissance
            if [[ ! -d "${folder}" ]]; then
                mkdir "${folder}"
            fi
            ;;  
        a)
            task="${OPTARG}"
            case ${task} in 
                "A01_NIKTO_INTERESTING_FILES")
                    run_task A01_NIKTO_INTERESTING_FILES "A01_NIKTO_INTERESTING_FILES"
                    ;;
                "A02_NIKTO_MISCONFIGURATION")
                    run_task A02_NIKTO_MISCONFIGURATION "A02_NIKTO_MISCONFIGURATION"
                    ;;
                "A03_NIKTO_INFORMATION_DISCLOSURE")
                    run_task A03_NIKTO_INFORMATION_DISCLOSURE "A03_NIKTO_INFORMATION_DISCLOSURE"
                    ;;
                "A04_NIKTO_INJECTION")
                    run_task A04_NIKTO_INJECTION "A04_NIKTO_INJECTION"
                    ;;
                "A05_NIKTO_REMOTE_FILE_RETRIEVAL1")
                    run_task A05_NIKTO_REMOTE_FILE_RETRIEVAL1 "A05_NIKTO_REMOTE_FILE_RETRIEVAL1"
                    ;;
                "A06_NIKTO_DENIAL_OF_SERVICE")
                    run_task A06_NIKTO_DENIAL_OF_SERVICE "A06_NIKTO_DENIAL_OF_SERVICE"
                    ;;
                "A07_NIKTO_REMOTE_FILE_RETRIEVAL2")
                    run_task A07_NIKTO_REMOTE_FILE_RETRIEVAL2 "A07_NIKTO_REMOTE_FILE_RETRIEVAL2"
                    ;;
                "A08_NIKTO_COMMAND_EXECUTION")
                    run_task A08_NIKTO_COMMAND_EXECUTION "A08_NIKTO_COMMAND_EXECUTION"
                    ;;
                "A09_NIKTO_SQL_INJECTION")
                    run_task A09_NIKTO_SQL_INJECTION "A09_NIKTO_SQL_INJECTION"
                    ;;
                "A10_NIKTO_FILE_UPLOAD")
                    run_task A10_NIKTO_FILE_UPLOAD "A10_NIKTO_FILE_UPLOAD"
                    ;;
                "A11_NIKTO_AUTHENTICATION_BYPASS")
                    run_task A11_NIKTO_AUTHENTICATION_BYPASS "A11_NIKTO_AUTHENTICATION_BYPASS"
                    ;;
                "A12_NIKTO_SOFTWARE_IDENTIFICATION")
                    run_task A12_NIKTO_SOFTWARE_IDENTIFICATION "A12_NIKTO_SOFTWARE_IDENTIFICATION"
                    ;;
                "A13_NIKTO_REMOTE_SOURCE_INCLUSION")
                    run_task A13_NIKTO_REMOTE_SOURCE_INCLUSION "A13_NIKTO_REMOTE_SOURCE_INCLUSION"
                    ;;
                "A14_NIKTO_WEBSERVICE")
                    run_task A14_NIKTO_WEBSERVICE "A14_NIKTO_WEBSERVICE"
                    ;;
                "A15_NIKTO_ADMINISTRATIVE_CONSOLE")
                    run_task A15_NIKTO_ADMINISTRATIVE_CONSOLE "A15_NIKTO_ADMINISTRATIVE_CONSOLE"
                    ;;
                esac
            ;;
        h)
            help_function
            exit 0
            ;;
        ?)
            echo "Error"
            exit 1
            ;;
        esac
    done