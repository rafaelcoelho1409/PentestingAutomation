#!/bin/bash
optstring=":hf:a:"
export PATH=~/go/bin:~/.cargo/bin:$PATH
TOOLS_PATH=~/TOOLS

#---AUXILIARY FUNCTIONS---
help_function() {
    echo "
    NIKTO SCAN

    Args:
        Warning: Use only folder name without spacebar
        [-f] Folder to store all data from vulnerability scan
        [-a] Choose a specific task to be done
        [-b] Change the file with domain names as input for Nuclei scans
             (Use this flag before -a flag)
            Options:
            - A01_NIKTO_INTERESTING_FILES
            - A02_NIKTO_MISCONFIGURATION
            - A03_NIKTO_INFORMATION_DISCLOSURE
            - A04_NIKTO_INJECTION
            - A05_REMOTE_FILE_RETRIEVAL1 (Inside Web Root)
            - A06_DENIAL_OF_SERVICE
            - A07_REMOTE_FILE_RETRIEVAL2 (Server Wide)
            - A08_COMMAND_EXECUTION
            - A09_SQL_INJECTION
            - A10_FILE_UPLOAD
            - A11_AUTHENTICATION_BYPASS
            - A12_SOFTWARE_IDENTIFICATION
            - A13_REMOTE_SOURCE_INCLUSION
            - A14_WEBSERVICE
            - A15_ADMINISTRATIVE_CONSOLE
        [-h] Help"
    exit 0
}   

run_task() {
    if [[ -n ${folder_init} ]]; then
        ${1}
    else
        echo "Error while running task ${2}"
        exit 1
    fi
}

banner() {
    printf '%*s' 100 | tr ' ' '-'
    echo -e "\n"
    echo -e "${1}\n"
    printf '%*s' 100 | tr ' ' '-'
    echo -e "\n"
}

clean_string() {
    local input=${1}
    # Replace - and / with _
    input="${input//[-\/]/_}"
    # Remove leading _ or /
    input="${input#[_/]}"
    # Remove trailing _ or /
    input="${input%[_/]}"
    echo "${input}"
}

nikto_scan() {
    path_name=${1}
    option=${2}
    file_to_scan=${3}
    #----------------------------------------
    if [[ -e ${file_to_scan} ]]; then
        for x in $(\
            cat ${file_to_scan}); do
            if [[ ! -d "${folder}/${path_name}" ]]; then
                mkdir -p "${folder}/${path_name}"
            fi
            nikto \
                -h ${x} \
                -Tuning ${option} \
                -Display V \
                -Save "${folder}/${path_name}"
        done
    fi
}


#---MAIN FUNCTIONS---
A01_NIKTO_INTERESTING_FILES() {
    stage="A01_NIKTO_INTERESTING_FILES"
    banner "NIKTO SCAN - ${stage}"
    path_name="A01_nikto_scans/A01_interesting_files_nikto"
    option=1
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A02_NIKTO_MISCONFIGURATION() {
    stage="A02_NIKTO_MISCONFIGURATION"
    banner "NIKTO SCAN - ${stage}"
    path_name="A01_nikto_scans/A02_misconfiguration_nikto"
    option=2
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A03_NIKTO_INFORMATION_DISCLOSURE() {
    stage="A03_NIKTO_INFORMATION_DISCLOSURE"
    banner "NIKTO SCAN - ${stage}"
    path_name="A01_nikto_scans/A03_information_disclosure_nikto"
    option=3
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A04_NIKTO_INJECTION() {
    stage="A04_NIKTO_INJECTION"
    banner "NIKTO SCAN - ${stage}"
    path_name="A01_nikto_scans/A04_injection_nikto"
    option=4
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A05_REMOTE_FILE_RETRIEVAL1() {
    stage="A05_REMOTE_FILE_RETRIEVAL1"
    banner "NIKTO SCAN - ${stage}"
    path_name="A01_nikto_scans/A05_remote_file_retrieval1_nikto"
    option=5
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A06_DENIAL_OF_SERVICE() {
    stage="A06_DENIAL_OF_SERVICE"
    banner "NIKTO SCAN - ${stage}"
    path_name="A01_nikto_scans/A06_denial_of_service_nikto"
    option=6
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A07_REMOTE_FILE_RETRIEVAL2() {
    stage="A07_REMOTE_FILE_RETRIEVAL2"
    banner "NIKTO SCAN - ${stage}"
    path_name="A01_nikto_scans/A07_remote_file_retrieval2_nikto"
    option=7
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A08_COMMAND_EXECUTION() {
    stage="A08_COMMAND_EXECUTION"
    banner "NIKTO SCAN - ${stage}"
    path_name="A01_nikto_scans/A08_command_execution_nikto"
    option=8
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A09_SQL_INJECTION() {
    stage="A09_SQL_INJECTION"
    banner "NIKTO SCAN - ${stage}"
    path_name="A01_nikto_scans/A09_sql_injection_nikto"
    option=9
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A10_FILE_UPLOAD() {
    stage="A10_FILE_UPLOAD"
    banner "NIKTO SCAN - ${stage}"
    path_name="A01_nikto_scans/A10_file_upload_nikto"
    option=0
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A11_AUTHENTICATION_BYPASS() {
    stage="A11_AUTHENTICATION_BYPASS"
    banner "NIKTO SCAN - ${stage}"
    path_name="A01_nikto_scans/A11_authentication_bypass_nikto"
    option=a
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A12_SOFTWARE_IDENTIFICATION() {
    stage="A12_SOFTWARE_IDENTIFICATION"
    banner "NIKTO SCAN - ${stage}"
    path_name="A01_nikto_scans/A12_software_identification_nikto"
    option=b
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A13_REMOTE_SOURCE_INCLUSION() {
    stage="A13_REMOTE_SOURCE_INCLUSION"
    banner "NIKTO SCAN - ${stage}"
    path_name="A01_nikto_scans/A13_remote_source_inclusion_nikto"
    option=c
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A14_WEBSERVICE() {
    stage="A14_WEBSERVICE"
    banner "NIKTO SCAN - ${stage}"
    path_name="A01_nikto_scans/A14_webservice_nikto"
    option=d
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}

A15_ADMINISTRATIVE_CONSOLE() {
    stage="A15_ADMINISTRATIVE_CONSOLE"
    banner "NIKTO SCAN - ${stage}"
    path_name="A01_nikto_scans/A15_administrative_console_nikto"
    option=e
    file_to_scan="${rec_folder}/subdomains/subdomains_probe.txt"
    nikto_scan ${path_name} ${option} ${file_to_scan}
}


#------------------------
while getopts ${optstring} options; do
    case ${options} in
        f)
            folder_init="${OPTARG}"
            folder=${folder_init}/Vulnerabilities
            rec_folder=${folder_init}/Reconnaissance
            nuclei_input="${rec_folder}/subdomains/subdomains_probe.txt"
            if [[ ! -d "${folder}" ]]; then
                mkdir "${folder}"
            fi
            ;;  
        a)
            task="${OPTARG}"
            case ${task} in 
                "A01_NIKTO_INTERESTING_FILES")
                    run_task A01_NIKTO_INTERESTING_FILES "A01_NIKTO_INTERESTING_FILES"
                    ;;
                "A02_NIKTO_MISCONFIGURATION")
                    run_task A02_NIKTO_MISCONFIGURATION "A02_NIKTO_MISCONFIGURATION"
                    ;;
                "A03_NIKTO_INFORMATION_DISCLOSURE")
                    run_task A03_NIKTO_INFORMATION_DISCLOSURE "A03_NIKTO_INFORMATION_DISCLOSURE"
                    ;;
                "A04_NIKTO_INJECTION")
                    run_task A04_NIKTO_INJECTION "A04_NIKTO_INJECTION"
                    ;;
                "A05_REMOTE_FILE_RETRIEVAL1")
                    run_task A05_REMOTE_FILE_RETRIEVAL1 "A05_REMOTE_FILE_RETRIEVAL1"
                    ;;
                "A06_DENIAL_OF_SERVICE")
                    run_task A06_DENIAL_OF_SERVICE "A06_DENIAL_OF_SERVICE"
                    ;;
                "A07_REMOTE_FILE_RETRIEVAL2")
                    run_task A07_REMOTE_FILE_RETRIEVAL2 "A07_REMOTE_FILE_RETRIEVAL2"
                    ;;
                "A08_COMMAND_EXECUTION")
                    run_task A08_COMMAND_EXECUTION "A08_COMMAND_EXECUTION"
                    ;;
                "A09_SQL_INJECTION")
                    run_task A09_SQL_INJECTION "A09_SQL_INJECTION"
                    ;;
                "A10_FILE_UPLOAD")
                    run_task A10_FILE_UPLOAD "A10_FILE_UPLOAD"
                    ;;
                "A11_AUTHENTICATION_BYPASS")
                    run_task A11_AUTHENTICATION_BYPASS "A11_AUTHENTICATION_BYPASS"
                    ;;
                "A12_SOFTWARE_IDENTIFICATION")
                    run_task A12_SOFTWARE_IDENTIFICATION "A12_SOFTWARE_IDENTIFICATION"
                    ;;
                "A13_REMOTE_SOURCE_INCLUSION")
                    run_task A13_REMOTE_SOURCE_INCLUSION "A13_REMOTE_SOURCE_INCLUSION"
                    ;;
                "A14_WEBSERVICE")
                    run_task A14_WEBSERVICE "A14_WEBSERVICE"
                    ;;
                "A15_ADMINISTRATIVE_CONSOLE")
                    run_task A15_ADMINISTRATIVE_CONSOLE "A15_ADMINISTRATIVE_CONSOLE"
                    ;;
                esac
            ;;
        h)
            help_function
            exit 0
            ;;
        ?)
            echo "Error"
            exit 1
            ;;
        esac
    done